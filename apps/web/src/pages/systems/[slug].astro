---
import { getComponentThumbnailUrl } from '@common';
import { SystemOverview } from '@composed';
import { SystemsLayout } from '@layouts';
import { ComponentCard } from '@ui';
import { getCollection, getEntry } from 'astro:content';

/**
 * Component information with thumbnail data
 */
interface ComponentInfo {
	slug: string;
	title: string;
	thumbnailData: {
		src: string;
		srcset: string;
	};
}

export async function getStaticPaths() {
	const systems = await getCollection('systemList');
	return systems.map((system) => ({
		params: { slug: system.data.slug },
		props: { system },
	}));
}

const { system } = Astro.props;
const entry = system;
if (!entry) throw new Error(`System not found`);

// Get system components
const systemComponentsEntry = await getEntry('systemComponents', `${entry.data.slug}/components`);
const systemComponentsData = systemComponentsEntry?.data;

// Get all components to match slugs with titles
const allComponents = await getCollection('componentList');
const componentMap = new Map(allComponents.map((c) => [c.data.slug, c.data.title]));

/**
 * Maps component slug to ComponentInfo if the component exists
 */
const mapComponentToInfo = (slug: string): ComponentInfo | null => {
	const title = componentMap.get(slug);
	if (!title) return null;

	return {
		slug,
		title,
		thumbnailData: getComponentThumbnailUrl(slug),
	};
};

// Map component slugs to component info with thumbnail data
const componentsInfo: ComponentInfo[] =
	systemComponentsData?.components
		.map(mapComponentToInfo)
		.filter((component): component is ComponentInfo => component !== null) ?? [];
---

<SystemsLayout
	title={`${entry.data.name} | UI Guideline`}
	description={`${entry.data.description}`}
	currentSlug={entry.data.slug}
>
	<div class="flex flex-col gap-16">
		<SystemOverview
			client:load
			slug={entry.data.slug}
			name={entry.data.name}
			description={entry.data.description}
			contributors={entry.data.contributors}
		/>

		<!-- System Components -->
		<section class="flex flex-col gap-6">
			<h1 id="components" class="text-xl font-bold m-0">Components</h1>
			<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
				{
					componentsInfo.map((component) => (
						<ComponentCard
							client:load
							title={component.title}
							slug={component.slug}
							thumbnailData={component.thumbnailData}
						/>
					))
				}
			</div>
		</section>
	</div>
</SystemsLayout>
