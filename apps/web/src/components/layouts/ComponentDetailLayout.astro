---
import { ComponentDetailTOC } from '@composed';
import { BaseLayout } from '@layouts';
import { loadData, ROUTES } from '@lib';
import { Navbar, SideBar, SideNav } from '@ui';
import { getCollection } from 'astro:content';

export interface Props {
	/**
	 * The title of the page.
	 */
	title: string;

	/**
	 * The description of the page for SEO.
	 */
	description?: string;

	/**
	 * The current component slug for active state.
	 */
	currentSlug?: string;

	/**
	 * Optional Table of Contents items.
	 */
	toc?: Array<{ id: string; label: string }>;
}

const { title, description, currentSlug, toc } = Astro.props;

// Get all components for navigation
const allComponents = await getCollection('components');

// Load categories data from /src/data/ (type automatically inferred as Category[])
const categories = (await loadData('categories.yml')) ?? [];
const categoryMap = new Map(categories.map((cat) => [cat.slug, cat.name]));

/**
 * Helper function to format category slug to display name
 * @param slug - The category slug (e.g., 'buttons', 'data-display')
 * @returns Formatted category name (e.g., 'Buttons', 'Data Display')
 */
const getCategoryName = (slug: string): string => {
	return categoryMap.get(slug) || slug.charAt(0).toUpperCase() + slug.slice(1);
};

// Group components by category
const componentsByCategory = allComponents.reduce(
	(acc, component) => {
		const category = component.data.category || 'uncategorized';
		if (!acc[category]) acc[category] = [];
		acc[category]!.push(component);
		return acc;
	},
	{} as Record<string, typeof allComponents>,
);

// Sort categories alphabetically (uncategorized goes last)
const sortedCategories = Object.keys(componentsByCategory).sort((a, b) => {
	if (a === 'uncategorized') return 1;
	if (b === 'uncategorized') return -1;
	return a.localeCompare(b);
});

// Sort components within each category alphabetically
sortedCategories.forEach((category) => {
	const components = componentsByCategory[category];
	if (components) {
		components.sort((a, b) => a.data.title.localeCompare(b.data.title));
	}
});
---

<BaseLayout title={title} description={description}>
	<!-- Top Navigation -->
	<header class="sticky top-0 w-full border-b border-border z-40">
		<Navbar className="@md:max-w-[1350px] mx-auto border-x border-border backdrop-blur-sm bg-background/90" />
	</header>

	<div class="flex flex-col min-h-screen @md:max-w-[1350px] mx-auto border-dashed-wide">
		<div class="flex flex-1 relative">
			<!-- Left Sidebar - Component Navigation (Fixed Width: 384px) -->
			<div class="hidden lg:block w-64 flex-shrink-0">
				<SideBar>
					<SideNav>
						<!-- Section - SECTIONS -->
						<SideNav.Section>
							<SideNav.Heading className="mb-4">Getting started</SideNav.Heading>
							<SideNav.List>
								<SideNav.Item level={1} isActive={Astro.url.pathname === ROUTES.LLMS_TXT}>
									<SideNav.Link level={1} href={ROUTES.LLMS_TXT} isActive={Astro.url.pathname === ROUTES.LLMS_TXT}>
										Introduction
									</SideNav.Link>
								</SideNav.Item>
								<SideNav.Item level={1} isActive={Astro.url.pathname === ROUTES.COMPONENTS}>
									<SideNav.Link level={1} href={ROUTES.COMPONENTS} isActive={Astro.url.pathname === ROUTES.COMPONENTS}>
										Components
									</SideNav.Link>
								</SideNav.Item>
								<SideNav.Item level={1} isActive={Astro.url.pathname === ROUTES.LLMS_TXT}>
									<SideNav.Link level={1} href={ROUTES.LLMS_TXT} isActive={Astro.url.pathname === ROUTES.LLMS_TXT}>
										MCP Server
									</SideNav.Link>
								</SideNav.Item>
								<SideNav.Item level={1} isActive={Astro.url.pathname === ROUTES.LLMS_TXT}>
									<SideNav.Link level={1} href={ROUTES.LLMS_TXT} isActive={Astro.url.pathname === ROUTES.LLMS_TXT}>
										llms.txt
									</SideNav.Link>
								</SideNav.Item>
								<SideNav.Item level={1} isActive={Astro.url.pathname === ROUTES.LLMS_TXT}>
									<SideNav.Link level={1} href={ROUTES.LLMS_TXT} isActive={Astro.url.pathname === ROUTES.LLMS_TXT}>
										Story
									</SideNav.Link>
								</SideNav.Item>
							</SideNav.List>
						</SideNav.Section>

						<!-- Section: COMPONENTS -->
						<SideNav.Section>
							<SideNav.Heading>Components</SideNav.Heading>
							<SideNav.List>
								{
									sortedCategories.map((categorySlug) => {
										const componentsInCategory = componentsByCategory[categorySlug];
										if (!componentsInCategory) return null;

										const categoryPath = `${ROUTES.COMPONENTS}/category/${categorySlug}`;
										const isCategoryActive = Astro.url.pathname === categoryPath;

										return (
											<>
												{/* Category Header */}
												<SideNav.Item level={0}>
													<SideNav.Link level={0} href={categoryPath} isActive={isCategoryActive}>
														{getCategoryName(categorySlug)}
													</SideNav.Link>
												</SideNav.Item>

												{/* Components in Category */}
												{componentsInCategory.map((component) => (
													<SideNav.Item level={1} isActive={currentSlug === component.data.slug}>
														<SideNav.Link
															level={1}
															href={`${ROUTES.COMPONENTS}/${component.data.slug}`}
															isActive={currentSlug === component.data.slug}
														>
															{component.data.title}
														</SideNav.Link>
													</SideNav.Item>
												))}
											</>
										);
									})
								}
							</SideNav.List>
						</SideNav.Section>
					</SideNav>
				</SideBar>
			</div>

			<!-- Main Content Area (Flexible) -->
			<main id="main-content" class="flex-1 min-w-0 px-6 py-8 lg:py-12" role="main">
				<article class="max-w-none">
					<slot />
				</article>
			</main>

			<!-- Right Sidebar - Table of Contents -->
			<div class="hidden xl:block w-60 flex-shrink-0">
				<aside
					class="sticky top-12 right-0 h-fit max-h-[calc(100dvh-var(--spacing)*14.25)] overflow-y-auto p-6"
					aria-label="Table of contents"
				>
					<ComponentDetailTOC client:load items={toc} className="sticky top-0 h-screen" />
				</aside>
			</div>
		</div>
	</div>
</BaseLayout>
